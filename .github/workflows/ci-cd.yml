name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop

jobs:
  # Job 1: Unit Tests
  unit-tests:
    name: Unit Tests (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    strategy:
      matrix:
        node-version: [18, 20, 22]
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Cache Jest cache
        uses: actions/cache@v4
        with:
          path: .jest-cache
          key: jest-cache-${{ runner.os }}-${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            jest-cache-${{ runner.os }}-${{ matrix.node-version }}-
            jest-cache-${{ runner.os }}-
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run unit tests with coverage
        run: npm run test:coverage
      
      - name: Check coverage thresholds
        run: |
          COVERAGE_FILE="coverage/unit/coverage-summary.json"
          if [ -f "$COVERAGE_FILE" ]; then
            LINES=$(node -p "require('./$COVERAGE_FILE').total.lines.pct")
            BRANCHES=$(node -p "require('./$COVERAGE_FILE').total.branches.pct")
            FUNCTIONS=$(node -p "require('./$COVERAGE_FILE').total.functions.pct")
            STATEMENTS=$(node -p "require('./$COVERAGE_FILE').total.statements.pct")
            
            echo "Coverage Results:"
            echo "  Lines: $LINES%"
            echo "  Branches: $BRANCHES%"
            echo "  Functions: $FUNCTIONS%"
            echo "  Statements: $STATEMENTS%"
            
            if (( $(echo "$LINES < 70" | bc -l) )); then
              echo "âŒ Line coverage ($LINES%) is below 70% threshold"
              exit 1
            fi
            
            echo "âœ… Coverage meets minimum threshold of 70%"
          else
            echo "âš ï¸ Coverage file not found, skipping threshold check"
          fi
      
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always() && matrix.node-version == 20
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results-node-${{ matrix.node-version }}
          path: test-results/junit-unit.xml
          retention-days: 30

  # Job 2: Integration Tests
  integration-tests:
    name: Integration Tests (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    strategy:
      matrix:
        node-version: [18, 20, 22]
      fail-fast: false
    
    services:
      rabbitmq:
        image: rabbitmq:3.12-management
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 30s
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Cache Jest cache
        uses: actions/cache@v4
        with:
          path: .jest-cache
          key: jest-cache-integration-${{ runner.os }}-${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            jest-cache-integration-${{ runner.os }}-${{ matrix.node-version }}-
            jest-cache-integration-${{ runner.os }}-
      
      - name: Install dependencies
        run: npm ci
      
      - name: Wait for RabbitMQ to be ready
        run: |
          echo "Waiting for RabbitMQ to be ready..."
          max_attempts=60
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            if curl -f -s http://localhost:15672/api/healthchecks/node > /dev/null 2>&1; then
              echo "âœ… RabbitMQ is ready!"
              exit 0
            fi
            echo "Attempt $attempt/$max_attempts: RabbitMQ not ready yet, waiting..."
            sleep 2
            attempt=$((attempt + 1))
          done
          echo "âŒ RabbitMQ failed to become ready after 120 seconds"
          exit 1
      
      - name: Run integration tests
        run: npm run test:integration
        env:
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results-node-${{ matrix.node-version }}
          path: test-results/
          retention-days: 30

  # Job 3: Build
  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Verify package structure
        run: |
          echo "Verifying package structure..."
          echo "Main entry point: $(node -p 'require("./package.json").main')"
          echo "Types entry point: $(node -p 'require("./package.json").types')"
          ls -la dist/
          echo "âœ… Package structure verified successfully"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist/
            package.json
            package-lock.json
            README.md
            LICENSE
            CHANGELOG.md
          retention-days: 7

  # Job 4: Publish to NPM (only on master branch)
  publish:
    name: Publish to NPM
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, build]
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'
          cache: 'npm'
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      - name: Get current version
        id: current
        run: |
          VERSION=$(node -p 'require("./package.json").version')
          NAME=$(node -p 'require("./package.json").name')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "ðŸ“¦ Package: $NAME"
          echo "ðŸ·ï¸  Version: $VERSION"
      
      - name: Check for changes in src folder
        id: src-changes
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          echo "Changed files in last commit:"
          echo "$CHANGED_FILES"
          
          if echo "$CHANGED_FILES" | grep -q "^src/"; then
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected in src/ folder"
          else
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  No changes in src/ folder"
          fi
      
      - name: Check if version already published
        id: version-check
        run: |
          PUBLISHED=$(npm view ${{ steps.current.outputs.name }}@${{ steps.current.outputs.version }} version 2>/dev/null || echo "null")
          if [ "$PUBLISHED" = "${{ steps.current.outputs.version }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  Version ${{ steps.current.outputs.version }} already exists on npm"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Version ${{ steps.current.outputs.version }} is new"
          fi
      
      - name: Create git tag
        if: |
          steps.version-check.outputs.exists == 'false' &&
          steps.src-changes.outputs.has-changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          TAG="v${{ steps.current.outputs.version }}"
          echo "Creating tag: $TAG"
          
          git fetch --tags --force
          
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "âš ï¸  Tag $TAG already exists locally"
          elif git ls-remote --tags origin | grep -q "refs/tags/$TAG"; then
            echo "âš ï¸  Tag $TAG already exists in remote"
          else
            git tag -a "$TAG" -m "Release $TAG"
            git push origin "$TAG"
            echo "âœ… Tag $TAG created and pushed"
          fi
      
      - name: Publish to NPM
        if: |
          steps.version-check.outputs.exists == 'false' &&
          steps.src-changes.outputs.has-changes == 'true'
        run: |
          echo "ðŸš€ Publishing ${{ steps.current.outputs.name }}@${{ steps.current.outputs.version }} to npm..."
          npm publish
          echo "âœ… Successfully published to npm!"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Skip publish - No src changes
        if: steps.src-changes.outputs.has-changes == 'false'
        run: echo "â­ï¸  Skipping publish - No changes in src/ folder"
      
      - name: Skip publish - Version exists
        if: |
          steps.version-check.outputs.exists == 'true' &&
          steps.src-changes.outputs.has-changes == 'true'
        run: echo "â­ï¸  Skipping publish - Version ${{ steps.current.outputs.version }} already exists on npm"

  # Job 5: Test Summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          echo "## ðŸ“Š Test Suite Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.unit-tests.result }}" == "success" ]; then
            echo "âœ… Unit Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Unit Tests: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.integration-tests.result }}" == "success" ]; then
            echo "âœ… Integration Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Integration Tests: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.unit-tests.result }}" != "success" ] || [ "${{ needs.integration-tests.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ Test suite failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All tests passed successfully" >> $GITHUB_STEP_SUMMARY
